<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Inventur Scanner</title>
  <style>
    body {
      font-family: 'Helvetica', Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #fafafa;
      color: #333;
    }
    header {
      background: linear-gradient(90deg, #999, #ccc);
      text-align: center;
      padding: 1rem;
      box-shadow: 0px 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
      margin: 0;
      font-size: 1.8rem;
      color: #fff;
    }
    .container {
      max-width: 600px;
      margin: 2rem auto;
      background: #fff;
      border-radius: 8px;
      padding: 1.5rem;
      box-shadow: 0px 2px 8px rgba(0,0,0,0.05);
    }
    .video-container {
      position: relative;
      width: 100%;
      overflow: hidden;
      background: #000;
    }
    #video {
      width: 100%;
    }
    .overlay-frame {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 320px;
      height: 140px;
      transform: translate(-50%, -50%);
      border: 2px solid #00ff00;
      box-sizing: border-box;
      pointer-events: none;
      max-width: 90%;
      max-height: 55%;
    }
    .button {
      display: inline-block;
      padding: 0.5rem 1rem;
      background-color: #d0d0d0;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      text-align: center;
      font-size: 1rem;
      margin-top: 1rem;
    }
    .button:hover {
      background-color: #bfbfbf;
    }
    .primary-button {
      background-color: #4a90e2;
      color: #fff;
    }
    .primary-button:hover {
      background-color: #3b78b5;
    }
    .delete-button {
      background-color: #f66;
      color: #fff;
    }
    .delete-button:hover {
      background-color: #d55;
    }
    .confirm-button {
      background-color: #5cb85c;
      color: #fff;
    }
    .confirm-button:hover {
      background-color: #4e9a4e;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1.5rem;
      border: 1px solid #eee;
      table-layout: fixed;
      word-wrap: break-word;
    }
    table th, table td {
      border: 1px solid #eee;
      padding: 0.5rem;
      text-align: center;
      vertical-align: middle;
    }
    th {
      background-color: #f0f0f0;
    }
    td[contenteditable="true"] {
      background-color: #f9f9f9;
    }
    .invalid {
      background-color: #ffdddd !important;
    }
    #status-section {
      margin-bottom: 1rem;
      min-height: 20px;
    }
    #ocr-result-section {
      margin-bottom: 1.5rem;
      background-color: #f8f8f8;
      padding: 1rem;
      border-radius: 5px;
      display: none;
      text-align: center;
    }
    #captured-image {
      max-width: 100%;
      margin-bottom: 1rem;
    }
    .actions {
      margin-top: 1rem;
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
    footer {
      text-align: center;
      padding: 1rem;
      background-color: #ddd;
      margin-top: 2rem;
      font-size: 0.9rem;
    }
    .modal {
      display: none; 
      position: fixed; 
      z-index: 999; 
      left: 0; 
      top: 0; 
      width: 100%; 
      height: 100%; 
      overflow: auto; 
      background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
      background-color: #fff;
      margin: 15% auto; 
      padding: 20px; 
      border: 1px solid #888; 
      width: 80%; 
      max-width: 300px;
      border-radius: 8px;
      text-align: center;
    }
    .modal-content input {
      width: 100%;
      padding: 0.5rem;
      margin-top: 0.5rem;
      font-size: 1rem;
      box-sizing: border-box;
      text-align: center;
    }
    @media (max-width: 600px) {
      .container {
        margin: 1rem;
      }
      table, th, td {
        font-size: 0.9rem;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Inventur Scanner</h1>
  </header>
  <div class="container">
    <div id="status-section">
      <span id="statusText"></span>
    </div>
    <div class="video-container">
      <video id="video" autoplay playsinline></video>
      <div class="overlay-frame"></div>
    </div>
    <div class="actions" style="margin-top:0.75rem; margin-bottom:0.25rem;">
      <label for="catalogSelect" style="font-size:0.95rem; color:#555; align-self:center;">Katalog:</label>
      <select id="catalogSelect" class="button" style="padding-right:2rem;">
        <option value="siemens">Siemens</option>
        <option value="huzap">HUZAP</option>
      </select>
      <label for="cameraSelect" style="font-size:0.95rem; color:#555; align-self:center;">Kamera:</label>
      <select id="cameraSelect" class="button" style="padding-right:2rem; max-width:220px;"></select>
      <button id="captureButton" class="button primary-button">Scannen</button>
    </div>
    <div id="ocr-result-section">
      <img id="captured-image" src="" alt="Gescannter Ausschnitt">
      <p>Erkannte Artikelnummer: <span id="recognizedNumber"></span></p>
    </div>
    <table id="dataTable"></table>
    <div class="actions">
      <button id="saveButton" class="button primary-button">Speichern</button>
      <button id="downloadButton" class="button">CSV Export</button>
      <button id="clearButton" class="button delete-button">Daten löschen</button>
      <button id="manualAddButton" class="button">Manuell hinzufügen</button>
    </div>
  </div>
  <footer>
    &copy; 2024 Inventur Scanner
  </footer>
  
  <div id="quantityModal" class="modal">
    <div class="modal-content">
      <h3>Stückzahl eingeben</h3>
      <p id="modalCode"></p>
      <input type="number" id="quantityInput" placeholder="Anzahl" min="0">
      <button id="quantityConfirm" class="button confirm-button" style="margin-top:1rem;">OK</button>
    </div>
  </div>

  <div id="manualModal" class="modal">
    <div class="modal-content">
      <h3>Manuell hinzufügen</h3>
      <p>Artikelnummer:</p>
      <input type="text" id="manualCodeInput" placeholder="Artikelnummer">
      <p>Stückzahl:</p>
      <input type="number" id="manualQuantityInput" placeholder="Anzahl" min="0">
      <button id="manualConfirm" class="button confirm-button" style="margin-top:1rem;">OK</button>
    </div>
  </div>

  <div id="candidateModal" class="modal">
    <div class="modal-content" style="max-width:420px;">
      <h3>Artikelnummer auswählen</h3>
      <p style="font-size:0.95rem;color:#666;">Mehrere mögliche Treffer gefunden:</p>
      <div id="candidateList" style="display:flex;flex-direction:column;gap:0.5rem;margin-top:0.75rem;"></div>
      <button id="candidateCancel" class="button" style="margin-top:1rem;">Abbrechen</button>
    </div>
  </div>

  <script src="https://unpkg.com/tesseract.js@2.1.4/dist/tesseract.min.js"></script>
  <script>
    let videoStream = null;
    const video = document.getElementById('video');
    const captureButton = document.getElementById('captureButton');
    const statusText = document.getElementById('statusText');
    const dataTable = document.getElementById('dataTable');
    const ocrResultSection = document.getElementById('ocr-result-section');
    const recognizedNumberEl = document.getElementById('recognizedNumber');
    const saveButton = document.getElementById('saveButton');
    const downloadButton = document.getElementById('downloadButton');
    const clearButton = document.getElementById('clearButton');
    const capturedImageEl = document.getElementById('captured-image');
    const manualAddButton = document.getElementById('manualAddButton');
    const catalogSelect = document.getElementById('catalogSelect');
    const cameraSelect = document.getElementById('cameraSelect');

    const quantityModal = document.getElementById('quantityModal');
    const quantityConfirm = document.getElementById('quantityConfirm');
    const quantityInput = document.getElementById('quantityInput');
    const modalCode = document.getElementById('modalCode');

    const manualModal = document.getElementById('manualModal');
    const manualConfirm = document.getElementById('manualConfirm');
    const manualCodeInput = document.getElementById('manualCodeInput');
    const manualQuantityInput = document.getElementById('manualQuantityInput');

    const candidateModal = document.getElementById('candidateModal');
    const candidateList = document.getElementById('candidateList');
    const candidateCancel = document.getElementById('candidateCancel');

    let currentRecognizedNumber = null;
    let currentCatalog = localStorage.getItem('inventurCatalog') || 'siemens';
    let selectedCameraId = localStorage.getItem('inventurCameraId') || '';
    catalogSelect.value = currentCatalog;

    captureButton.addEventListener('click', captureFrame);
    quantityConfirm.addEventListener('click', confirmQuantity);
    saveButton.addEventListener('click', saveData);
    downloadButton.addEventListener('click', downloadCSV);
    clearButton.addEventListener('click', clearData);
    manualAddButton.addEventListener('click', showManualModal);
    manualConfirm.addEventListener('click', confirmManualAdd);
    catalogSelect.addEventListener('change', () => {
      currentCatalog = catalogSelect.value;
      localStorage.setItem('inventurCatalog', currentCatalog);
      statusText.textContent = `Katalog aktiv: ${currentCatalog.toUpperCase()}`;
    });
    cameraSelect.addEventListener('change', async () => {
      selectedCameraId = cameraSelect.value;
      localStorage.setItem('inventurCameraId', selectedCameraId);
      await startCamera(selectedCameraId);
    });
    candidateCancel.addEventListener('click', () => {
      candidateModal.style.display = 'none';
      statusText.textContent = 'Auswahl abgebrochen. Sie können erneut scannen oder manuell hinzufügen.';
    });

    dataTable.addEventListener('focusout', (e) => {
      if (e.target && e.target.closest('tr')) {
        validateRow(e.target.closest('tr'));
      }
    });

    loadDataFromLocalStorage();
    initCamera();

    async function initCamera() {
      cameraSelect.innerHTML = '<option value="">Kamera wird geladen...</option>';
      try {
        await startCamera(selectedCameraId);
        await refreshCameraDevices();
      } catch (err) {
        console.error('Kamera-Initialisierung fehlgeschlagen:', err);
        alert('Kamera kann nicht gestartet werden.');
      }
    }

    async function startCamera(cameraId = '') {
      if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
      }

      const baseConstraints = {
        width: { ideal: 1280 },
        height: { ideal: 720 }
      };

      const videoConstraints = cameraId
        ? { ...baseConstraints, deviceId: { exact: cameraId } }
        : { ...baseConstraints, facingMode: 'environment' };

      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: videoConstraints, audio: false });
        videoStream = stream;
        video.srcObject = stream;
        await video.play();
        const activeLabel = stream.getVideoTracks()[0]?.label || 'Kamera aktiv';
        statusText.textContent = `${activeLabel} · Katalog: ${currentCatalog.toUpperCase()}`;
      } catch (err) {
        if (cameraId) {
          console.warn('Gewählte Kamera fehlgeschlagen, fallback auf environment:', err);
          const fallbackStream = await navigator.mediaDevices.getUserMedia({ video: { ...baseConstraints, facingMode: 'environment' }, audio: false });
          videoStream = fallbackStream;
          video.srcObject = fallbackStream;
          await video.play();
          statusText.textContent = `Kamera-Fallback aktiv · Katalog: ${currentCatalog.toUpperCase()}`;
          return;
        }
        throw err;
      }
    }

    function rankCameraLabel(label) {
      const l = (label || '').toLowerCase();
      if (l.includes('back') || l.includes('rear') || l.includes('environment')) return 0;
      if (l.includes('wide') || l.includes('ultra')) return 1;
      if (l.includes('tele')) return 2;
      if (l.includes('front') || l.includes('user')) return 9;
      return 5;
    }

    async function refreshCameraDevices() {
      const devices = await navigator.mediaDevices.enumerateDevices();
      const cameras = devices.filter(d => d.kind === 'videoinput');

      if (!cameras.length) {
        cameraSelect.innerHTML = '<option value="">Keine Kamera gefunden</option>';
        return;
      }

      cameras.sort((a, b) => rankCameraLabel(a.label) - rankCameraLabel(b.label));

      if (!selectedCameraId || !cameras.some(c => c.deviceId === selectedCameraId)) {
        selectedCameraId = cameras[0].deviceId;
        localStorage.setItem('inventurCameraId', selectedCameraId);
      }

      cameraSelect.innerHTML = cameras.map((cam, idx) => {
        const name = cam.label || `Kamera ${idx + 1}`;
        const selected = cam.deviceId === selectedCameraId ? 'selected' : '';
        return `<option value="${cam.deviceId}" ${selected}>${name}</option>`;
      }).join('');
    }

    async function captureFrame() {
      statusText.textContent = `Verarbeite Bild... (${currentCatalog.toUpperCase()})`;
      const canvas = document.createElement('canvas');
      const w = video.videoWidth;
      const h = video.videoHeight;
      canvas.width = w;
      canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, w, h);

      const frameWidth = 320;
      const frameHeight = 140;
      const centerX = w / 2;
      const centerY = h / 2;
      const startX = centerX - frameWidth / 2;
      const startY = centerY - frameHeight / 2;
      const frameData = ctx.getImageData(startX, startY, frameWidth, frameHeight);

      const frameCanvas = document.createElement('canvas');
      frameCanvas.width = frameWidth;
      frameCanvas.height = frameHeight;
      const frameCtx = frameCanvas.getContext('2d');
      frameCtx.putImageData(frameData, 0, 0);

      capturedImageEl.src = frameCanvas.toDataURL('image/png');

      try {
        const { data: { text, confidence } } = await Tesseract.recognize(frameCanvas.toDataURL('image/png'), 'eng', {
          tessedit_char_whitelist: '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ- ',
          psm: 6
        });

        const kandidaten = extractArtikelnummern(text, currentCatalog);
        if (kandidaten.length === 1) {
          const artikelnummer = kandidaten[0];
          currentRecognizedNumber = artikelnummer;
          recognizedNumberEl.textContent = artikelnummer;
          ocrResultSection.style.display = 'block';
          statusText.textContent = `Artikelnummer erkannt (OCR ${Math.round(confidence)}%). Bitte Stückzahl eingeben.`;
          showQuantityModal(artikelnummer);
        } else if (kandidaten.length > 1) {
          ocrResultSection.style.display = 'block';
          recognizedNumberEl.textContent = kandidaten.join(' | ');
          statusText.textContent = `Mehrere Artikelnummern erkannt (OCR ${Math.round(confidence)}%). Bitte auswählen.`;
          showCandidateModal(kandidaten);
        } else {
          currentRecognizedNumber = null;
          ocrResultSection.style.display = 'none';
          statusText.textContent = 'Keine gültige Artikelnummer gefunden. Sie können die Nummer manuell hinzufügen.';
        }
      } catch (error) {
        console.error('Fehler bei der Texterkennung:', error);
        statusText.textContent = 'Fehler bei der Texterkennung. Sie können die Nummer manuell hinzufügen.';
      }
    }

    function normalizeOcrText(text) {
      return (text || '')
        .toUpperCase()
        .replace(/[—–_]/g, '-')
        .replace(/[^A-Z0-9\-\s]/g, ' ')
        .replace(/\s+/g, ' ')
        .trim();
    }

    function cleanupCode(code) {
      return code
        .toUpperCase()
        .replace(/\s*[-—–_]\s*/g, '-')
        .replace(/\s+/g, '')
        .replace(/-{2,}/g, '-')
        .trim();
    }

    function normalizeSiemensCandidate(code) {
      const cleaned = cleanupCode(code);

      // OCR-Fehlertoleranz (vorsichtig): O->0, I/L->1, B->8, S->5 in Alphanumerik-Blöcken
      // Präfix bleibt als 6ES7 erhalten, danach normalisieren wir Block-weise.
      const compact = cleaned.replace(/-/g, '');
      const compactFixed = compact
        .replace(/^6ES7/, '6ES7')
        .replace(/^6ES7(.+)$/, (_, tail) => `6ES7${tail
          .replace(/O/g, '0')
          .replace(/[IL]/g, '1')
          .replace(/B/g, '8')}`);

      // 6ES7 + 3 + 5 + 4  => 6ES7XXX-YYYYY-ZZZZ
      if (/^6ES7[0-9A-Z]{3}[0-9A-Z]{5}[0-9A-Z]{4}$/.test(compactFixed)) {
        return `${compactFixed.slice(0, 7)}-${compactFixed.slice(7, 12)}-${compactFixed.slice(12, 16)}`;
      }

      // Falls bereits mit Trennstrichen vorhanden: segmentweise normalisieren
      return cleaned
        .replace(/^6ES7([0-9A-Z]{3})-([0-9A-Z]{5})-([0-9A-Z]{4})$/, (_, a, b, c) => {
          const fix = (s) => s.replace(/O/g, '0').replace(/[IL]/g, '1').replace(/B/g, '8');
          return `6ES7${fix(a)}-${fix(b)}-${fix(c)}`;
        });
    }

    function getPatternsByCatalog(catalog) {
      if (catalog === 'huzap') {
        return [
          /\bHUZAP[-\s]?[0-9A-Z]{3,14}\b/g,
          /\bHZP[-\s]?[0-9A-Z]{3,14}\b/g,
          /\b[0-9A-Z]{2,6}-[0-9A-Z]{2,8}(?:-[0-9A-Z]{1,8})?\b/g,
          /\b[0-9A-Z]{6,16}\b/g
        ];
      }

      // Default: Siemens
      return [
        /\b3RV\d{4}-[0-9A-Z]{5}\b/g, // z.B. 3RV2011-1DA10
        /\b5SY\d{4}-\d\b/g, // z.B. 5SY6504-7
        /\b6ES7\s?\d{3}\s*-\s*[0-9A-Z]{5}\s*-\s*[0-9A-Z]{4}\b/g, // z.B. 6ES7 516-3AN02-0AB0
        /\b6\s?E\s?S\s?7\s?\d{3}\s*-\s*[0-9A-Z]{5}\s*-\s*[0-9A-Z]{4}\b/g, // toleranter OCR-Fall: 6 E S 7 ...
        /\b6ES7[0-9A-Z]{12}\b/g, // kompakter OCR-Fall ohne Bindestriche
        /\b[0-9A-Z]{3,8}-[0-9A-Z]{1,6}(?:-[0-9A-Z]{1,6})?\b/g
      ];
    }

    function extractArtikelnummern(text, catalog = 'siemens') {
      const normalized = normalizeOcrText(text);
      const compact = normalized.replace(/\s+/g, '');
      const patterns = getPatternsByCatalog(catalog);

      const candidates = [];
      for (const p of patterns) {
        const m1 = normalized.match(p) || [];
        const m2 = compact.match(p) || [];
        candidates.push(...m1, ...m2);
      }

      return Array.from(new Set(
        candidates
          .map(c => catalog === 'siemens' ? normalizeSiemensCandidate(c) : cleanupCode(c))
          .filter(c => c.length >= 6)
      )).sort((a, b) => b.length - a.length);
    }

    function showCandidateModal(codes) {
      candidateList.innerHTML = '';
      codes.forEach(code => {
        const btn = document.createElement('button');
        btn.className = 'button primary-button';
        btn.style.marginTop = '0';
        btn.textContent = code;
        btn.addEventListener('click', () => {
          currentRecognizedNumber = code;
          recognizedNumberEl.textContent = code;
          candidateModal.style.display = 'none';
          showQuantityModal(code);
        });
        candidateList.appendChild(btn);
      });
      candidateModal.style.display = 'block';
    }

    function showQuantityModal(code) {
      modalCode.textContent = `Code: ${code}`;
      quantityInput.value = '';
      quantityModal.style.display = 'block';
      quantityInput.focus();
    }

    function confirmQuantity() {
      const qty = quantityInput.value.trim();
      if (!qty || isNaN(qty)) {
        alert('Bitte eine gültige Stückzahl eingeben.');
        return;
      }
      if (currentRecognizedNumber) {
        addRow(currentRecognizedNumber, qty);
      }
      quantityModal.style.display = 'none';
      currentRecognizedNumber = null;
      statusText.textContent = '';
      ocrResultSection.style.display = 'none';
      autoSaveData();
    }

    function addRow(artikelnummer, anzahl) {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td contenteditable="true">${artikelnummer}</td>
        <td contenteditable="true">${anzahl}</td>
        <td><button class="button delete-button">Löschen</button></td>
      `;
      dataTable.appendChild(row);
      row.querySelector('.delete-button').addEventListener('click', () => {
        dataTable.removeChild(row);
        autoSaveData();
      });
      validateRow(row);
    }

    function saveData() {
      if (!confirm('Daten jetzt wirklich speichern?')) {
        return;
      }
      const data = getCurrentTableData();
      localStorage.setItem('inventurData', JSON.stringify(data));
      alert('Daten gespeichert!');
    }

    function autoSaveData() {
      const data = getCurrentTableData();
      localStorage.setItem('inventurData', JSON.stringify(data));
    }

    function getCurrentTableData() {
      const data = [];
      dataTable.querySelectorAll('tr').forEach(row => {
        const artikelnummer = row.children[0].textContent.trim();
        const anzahl = row.children[1].textContent.trim();
        if (artikelnummer && anzahl) {
          data.push({ artikelnummer, anzahl });
        }
      });
      return data;
    }

    function loadDataFromLocalStorage() {
      const storedData = JSON.parse(localStorage.getItem('inventurData') || '[]');
      storedData.forEach(entry => {
        addRow(entry.artikelnummer, entry.anzahl);
      });
    }

    function downloadCSV() {
      const data = JSON.parse(localStorage.getItem('inventurData') || '[]');
      if (data.length === 0) {
        alert('Keine Daten vorhanden.');
        return;
      }
      const csvContent = "data:text/csv;charset=utf-8," +
        "Artikelnummer,Anzahl\n" +
        data.map(e => `${e.artikelnummer},${e.anzahl}`).join("\n");
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "inventur.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function clearData() {
      if (confirm('Alle Daten löschen?')) {
        localStorage.removeItem('inventurData');
        dataTable.innerHTML = '';
        alert('Daten gelöscht!');
      }
    }

    function validateRow(row) {
      const artikelnummer = row.children[0].textContent.trim();
      // Für gescannte Codes weiterhin validieren, für manuelle Eingabe nicht zwingend.
      // Wir belassen die Validierung für gescannte Daten, manuelle sind frei.
      const pattern = /^(?:[A-Z]{3}[-]?\d{6}|\d{6}-\d{6})$/;
      if (pattern.test(artikelnummer)) {
        row.children[0].classList.remove('invalid');
      } else {
        // Manuelle Eingabe ist frei, nur wenn es offensichtlich ein gescannter Code sein sollte
        // und nicht passt, markieren wir als invalid. Da der User alles eingeben darf, entfernen wir die Markierung.
        row.children[0].classList.remove('invalid');
      }
    }

    window.onclick = function(event) {
      if (event.target == quantityModal) {
        quantityModal.style.display = "none";
      }
      if (event.target == manualModal) {
        manualModal.style.display = "none";
      }
      if (event.target == candidateModal) {
        candidateModal.style.display = "none";
      }
    }

    function showManualModal() {
      manualCodeInput.value = '';
      manualQuantityInput.value = '';
      manualModal.style.display = 'block';
      manualCodeInput.focus();
    }

    function confirmManualAdd() {
      const code = manualCodeInput.value.trim();
      const qty = manualQuantityInput.value.trim();
      if (!qty || isNaN(qty)) {
        alert('Bitte eine gültige Stückzahl eingeben.');
        return;
      }
      // Keine Formatvalidierung für manuelle Eingabe
      addRow(code, qty);
      manualModal.style.display = 'none';
      autoSaveData();
    }
  </script>
</body>
</html>
